<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Language" content="ja" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="shortcut icon" href="assets/favicon/favicon.ico" type="image/vnd.microsoft.icon">
  <link rel="icon" href="assets/favicon/favicon.ico" type="image/vnd.microsoft.icon">
  <link rel="stylesheet" type="text/css" href="assets/css/style.css">
  <link rel="stylesheet" type="text/css" href="assets/css/result.css">

  <title>コダックメーカー</title>
  <!--[if IE]><script type="text/javascript" src="excanvas.js"></script><![endif]-->
<!--
  <script type="text/javascript" src="lib/script.js"></script>
  <script type="text/javascript" src="lib/marked.js"></script>
  <link rel="stylesheet" type="text/css" href="assets/css/style.css">
  <link rel="stylesheet" type="text/css" href="assets/css/slidemenu.css">
-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  </head>
  <body>

    <div id="toolBar">
      <img src="assets/Psyduck-logo.png" width="300" height="40">
      <div id="animate-image">
        <img src="assets/Psyduck-animation.gif">
      </div>
    </div>

    <div id="toolBtns">
      <p><input type="button" id="backBtn" value="戻る" onclick="location.href='/index.html'"></p>
    </div>

    <!--隠してある-->
    <div hidden><p><canvas id="psyduck-canvas" width="600" height="440"></canvas></p></div>
    <p class="resizeimage"><img id="newImg"></p>
    <textarea name="text" id="tweetField" cols="50" rows="5">
    初期値
    #コダックメーカー
    </textarea>
    <br>
    <input type ="submit" name="submit" id="tweetBtn" value ="ツイート" onclick="submit();">
    <!--
    <a href="https://twitter.com/share" class="twitter-share-button" data-url="https://psyduck-maker.herokuapp.com/" data-text="コダックメーカーを使っています。" data-hashtags="コダックメーカー">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  -->
    <br>
    <br>
    <br>

    <div id="footer">
      <p>Copyright(c) 2016 n_atmark all right reserved.</p>
    </div>
    <script>
    onload = function() {
      draw();
    };
    function getImgAndTxt(){
      /* アドレスの「?」以降の引数(パラメータ)を取得 */
      var pram=location.search;
      /* 引数がない時は処理しない */
      if (!pram) return false;
      /* 先頭の?をカット */
      pram=pram.substring(1);
      /* 「&」で引数を分割して配列に */
      var pair=pram.split("&");
      var i=temp="";
      var key=new Array();
      for (i=0; i < pair.length; i++) {
        /* 配列の値を「=」で分割 */
        temp=pair[i].split("=");
        keyName=temp[0];
        keyValue=temp[1];
        /* キーと値の連想配列を生成 */
        key[keyName]=keyValue;
      }
      var text=image="";
      /* 名前 */
      if (!key["text"] || key["text"]==""){
        text="";
      }else{
        /* コード変換 */
        text=unescape(key["text"]);
      }
      if(!key["image"] || key["image"]=="") {
        image="";
      }else{
        image=unescape(key["image"]);
      }
      return {'image':image,'text':text};
    }
    function draw() {

      var data = getImgAndTxt();
      var image = data['image'];
      var text = data['text'];

      document.getElementsByName('text')[0].innerHTML = text + "\n#コダックメーカー"

      /* canvas要素のノードオブジェクト */
      var canvas = document.getElementById('psyduck-canvas');
      /* canvas要素の存在チェックとCanvas未対応ブラウザの対処 */
      if ( ! canvas || ! canvas.getContext ) {
        return false;
      }
      /* 2Dコンテキスト */
      var ctx = canvas.getContext('2d');
      /* Imageオブジェクトを生成 */
      var img = new Image();
      img.src = "assets/" + image;
      /* 画像が読み込まれるのを待ってから処理を続行 */
      img.onload = function() {
        ctx.drawImage(img, 0, 0,600,440);
        //ctx2.fillText('fillText(text,x,y[,maxWidth])',15,55,520);
        //ctx.font= 'normal 82px Century Gothic,"Hiragino Kaku Gothic ProN", ヒラギノ角ゴ ProN W3"';
        ctx.font= 'normal 44px "HiraginoSans-W0","Hiragino Kaku Gothic ProN","ヒラギノ角ゴ ProN W3","Helvetica Neue","Meiryo UI"';
        ctx.textAlign = 'center';
        ctx.fillStyle = "#48656c";
        ctx.fillText(text,300,404);
        chgImg();
      }
    }
    function submit(){
      var tweet = document.getElementsByName('text')[0].value;
      var b64 = document.getElementById('newImg').src.toString();

      var data = getImgAndTxt();
      var image = data['image'];
      var text = data['text'];

      //location.href='auth/twitter?tweet='+escape(tweet)+'&binary='+escape(b64)+'&text='+escape(text)+'&image='+escape(image);
      postJump('https://psyduck-maker.herokuapp.com/post',['tweet','binary','imgSrc','text'],[tweet,b64,image,text]);
    }
    function postJump(_url, _keys, _vals){
      var html = '<form method="post" action="'+_url+'" id="postjump" style="display: none;">';
      for(var cnt=0;cnt<_keys.length;cnt++){
          html += '<input type="hidden" name="'+_keys[cnt]+'" value="'+_vals[cnt]+'" >';
      }
      html += '</form>';
      $("body").append(html);
      $('#postjump').submit();
      $('#postjump').remove();
    }
    function chgImg(){
      try {
        /* canvas要素のノードオブジェクト */
        var canvas = document.getElementById('psyduck-canvas');
        var img = new Image()
        img.src = canvas.toDataURL();
        img.onload = function() {
          document.getElementById("newImg").src = img.src;
        }
      } catch(e) {
        document.getElementById("newImg").alt = "未対応";
      }
    }
    </script>
  </body>
</html>
